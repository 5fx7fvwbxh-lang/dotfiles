#!/usr/bin/env bash

set -e

CONFIG="install.conf.yaml"
DOTBOT_DIR="dotbot"

DOTBOT_BIN="bin/dotbot"
BASEDIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if required packages are installed
check_dependencies() {
    local missing_packages=()
    local required_packages=("git" "zsh" "tmux" "vim")
    
    echo "Checking for required packages..."
    
    for package in "${required_packages[@]}"; do
        if ! command -v "$package" &> /dev/null; then
            missing_packages+=("$package")
        else
            echo -e "${GREEN}✓${NC} $package is installed"
        fi
    done
    
    if [ ${#missing_packages[@]} -gt 0 ]; then
        echo -e "\n${RED}Missing packages:${NC} ${missing_packages[*]}"
        
        if [[ "$OSTYPE" == "darwin"* ]]; then
            echo -e "\n${YELLOW}macOS detected.${NC} Installing with Homebrew..."
            if ! command -v brew &> /dev/null; then
                echo -e "${RED}Homebrew is not installed. Please install it first from https://brew.sh${NC}"
                exit 1
            fi
            brew install ${missing_packages[*]}
        else
            echo -e "\n${YELLOW}Linux detected.${NC} Installing with package manager..."
            if command -v apt &> /dev/null; then
                sudo apt update && sudo apt install -y ${missing_packages[*]}
            else
                echo -e "${RED}No support for this package manager. Please install manually: ${missing_packages[*]}${NC}"
                exit 1
            fi
        fi
        
        echo -e "\n${GREEN}All missing packages have been installed!${NC}\n"
    fi
    
    echo -e "\n${GREEN}All required packages are installed!${NC}\n"
}

# Backup existing dotfiles
backup_existing_dotfiles() {
    local backup_dir="$HOME/.dotfiles_backup_$(date +%Y%m%d_%H%M%S)"
    local files_to_backup=(
        "$HOME/.bashrc"
        "$HOME/.bash_profile"
        "$HOME/.zshrc"
        "$HOME/.gitconfig"
        "$HOME/.gitignore_global"
        "$HOME/.pythonrc"
        "$HOME/.tmux.conf"
        "$HOME/.vimrc"
        "$HOME/.gnupg/gpg.conf"
    )
    
    local backed_up=false
    
    for file in "${files_to_backup[@]}"; do
        if [ -e "$file" ] && [ ! -L "$file" ]; then
            if [ "$backed_up" = false ]; then
                mkdir -p "$backup_dir"
                echo -e "\n${YELLOW}Backing up existing dotfiles to:${NC} $backup_dir\n"
                backed_up=true
            fi
            echo -e "${YELLOW}→${NC} Backing up: $file"
            cp -r "$file" "$backup_dir/"
        fi
    done
    
    if [ "$backed_up" = true ]; then
        echo -e "\n${GREEN}Backup completed!${NC}\n"
    fi
}

# Check dependencies before proceeding
check_dependencies

# Backup existing files
backup_existing_dotfiles

cd "${BASEDIR}"
git -C "${DOTBOT_DIR}" submodule sync --quiet --recursive
git submodule update --init --recursive "${DOTBOT_DIR}"

"${BASEDIR}/${DOTBOT_DIR}/${DOTBOT_BIN}" -d "${BASEDIR}" -c "${CONFIG}" "${@}"
